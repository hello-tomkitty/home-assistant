climate_scheduler_set_all_groups_profile:
  alias: Climate Scheduler - Set all groups profile
  mode: single
  fields:
    profile_name:
      description: Profile to activate across all Climate Scheduler groups (must match
        preset_modes exactly)
      example: 'Vacation: Multiple-Day Absence'
  sequence:
  - variables:
      schedule_entities: "{{ states.climate\n  | selectattr('entity_id','match','^climate\\.climate_scheduler_climate_schedule_')\n
        \ | map(attribute='entity_id')\n  | list }}"
  - variables:
      applied_count: 0
      skipped_missing_profile: []
      skipped_missing_group_name: []
      skipped_no_preset_modes: []
  - repeat:
      for_each: '{{ schedule_entities }}'
      sequence:
      - variables:
          sched_entity: '{{ repeat.item }}'
          group_name: '{{ state_attr(sched_entity, ''group_name'') }}'
          preset_modes: '{{ state_attr(sched_entity, ''preset_modes'') }}'
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ group_name is none or (group_name | string | trim)
              == '''' }}'
          sequence:
          - variables:
              skipped_missing_group_name: '{{ skipped_missing_group_name + [sched_entity]
                }}'
        - conditions:
          - condition: template
            value_template: '{{ preset_modes is none }}'
          sequence:
          - variables:
              skipped_no_preset_modes: '{{ skipped_no_preset_modes + [ (group_name
                or sched_entity) ~ '' ('' ~ sched_entity ~ '')'' ] }}'
        - conditions:
          - condition: template
            value_template: '{{ profile_name in preset_modes }}'
          sequence:
          - action: climate_scheduler.set_active_profile
            data:
              schedule_id: '{{ group_name }}'
              profile_name: '{{ profile_name }}'
          - variables:
              applied_count: '{{ applied_count + 1 }}'
        - conditions: []
          sequence:
          - variables:
              skipped_missing_profile: "{{ skipped_missing_profile\n   + [ (group_name
                or 'UNKNOWN') ~ ' (' ~ sched_entity ~ ') supports: ' ~ (preset_modes
                | join(', ')) ] }}"
  - choose:
    - conditions:
      - condition: template
        value_template: "{{ applied_count == 0\n   or (skipped_missing_profile | length)
          > 0\n   or (skipped_missing_group_name | length) > 0\n   or (skipped_no_preset_modes
          | length) > 0 }}"
      sequence:
      - action: persistent_notification.create
        data:
          title: Climate Scheduler - Profile apply result
          message: 'Requested profile: "{{ profile_name }}" Groups found: {{ schedule_entities
            | length }} Applied to: {{ applied_count }}

            {% if applied_count == 0 %} ❌ Applied to none. The profile likely doesn''t
            exist on any schedule (or schedules couldn''t be resolved). {% endif %}

            ⚠️ Skipped (profile missing) ({{ skipped_missing_profile | length }}):
            {% if skipped_missing_profile | length == 0 %}(none){% else %} - {{ skipped_missing_profile
            | join(''\n- '') }} {% endif %}

            ⚠️ Skipped (missing group_name) ({{ skipped_missing_group_name | length
            }}): {% if skipped_missing_group_name | length == 0 %}(none){% else %}
            - {{ skipped_missing_group_name | join(''\n- '') }} {% endif %}

            ⚠️ Skipped (no preset_modes attribute) ({{ skipped_no_preset_modes | length
            }}): {% if skipped_no_preset_modes | length == 0 %}(none){% else %} -
            {{ skipped_no_preset_modes | join(''\n- '') }} {% endif %}'
climate_scheduler_audit_profiles_consistency:
  alias: Climate Scheduler - Audit profiles & consistency
  mode: single
  fields:
    verbose:
      description: If true, always post the report. If false, only notify when issues
        are found.
      example: true
  sequence:
  - variables:
      verbose_mode: '{{ verbose | default(false) }}'
      helper: input_select.climate_active_profile
      schedules: "{{ states.climate\n  | selectattr('entity_id','match','^climate\\.climate_scheduler_climate_schedule_')\n
        \ | map(attribute='entity_id')\n  | list }}"
      helper_options: '{{ state_attr(helper, ''options'') or [] }}'
  - variables:
      issues_found: "{% set issues = false %}\n{% if states[helper] is none %}\n  {%
        set issues = true %}\n{% endif %}\n{% if helper_options | length == 0 %}\n
        \ {% set issues = true %}\n{% endif %}\n{% if schedules | length == 0 %}\n
        \ {% set issues = true %}\n{% else %}\n  {# check missing/extra across schedules
        #}\n  {% for e in schedules %}\n    {% set modes = state_attr(e,'preset_modes')
        or [] %}\n\n    {% for ho in helper_options %}\n      {% if ho not in modes
        %}\n        {% set issues = true %}\n      {% endif %}\n    {% endfor %}\n\n
        \   {% for m in modes %}\n      {% if m not in helper_options %}\n        {%
        set issues = true %}\n      {% endif %}\n    {% endfor %}\n  {% endfor %}\n\n
        \ {# whitespace/spelling variants: same normalized string with >1 raw variant
        #}\n  {% set norm = namespace(map={}) %}\n  {% for raw in helper_options %}\n
        \   {% set k = raw | regex_replace('\\s+',' ') | trim %}\n    {% set cur =
        norm.map.get(k, []) %}\n    {% if raw not in cur %}\n      {% set cur = cur
        + [raw] %}\n    {% endif %}\n    {% set norm.map = dict(norm.map, **{k: cur})
        %}\n  {% endfor %}\n  {% for e in schedules %}\n    {% set modes = state_attr(e,'preset_modes')
        or [] %}\n    {% for raw in modes %}\n      {% set k = raw | regex_replace('\\s+','
        ') | trim %}\n      {% set cur = norm.map.get(k, []) %}\n      {% if raw not
        in cur %}\n        {% set cur = cur + [raw] %}\n      {% endif %}\n      {%
        set norm.map = dict(norm.map, **{k: cur}) %}\n    {% endfor %}\n  {% endfor
        %}\n\n  {% for k, cur in norm.map.items() %}\n    {% if cur | length > 1 %}\n
        \     {% set issues = true %}\n    {% endif %}\n  {% endfor %}\n{% endif %}\n{{
        issues }}"
      status_icon: '{{ ''❌'' if issues_found else ''✅'' }}'
      status_text: '{{ ''FAIL (issues found)'' if issues_found else ''PASS (no issues
        found)'' }}'
      notif_title: '{{ status_icon ~ '' Climate Scheduler Audit — '' ~ (''FAIL'' if
        issues_found else ''PASS'') }}'
      report: "{{ status_icon }} Climate Scheduler Audit: {{ status_text }}\n\nHelper:
        {{ helper }}\nHelper exists: {{ states[helper] is not none }}\nSchedules found:
        {{ schedules | length }}\n\n=== Helper options (raw, exact) ===\n{% if helper_options
        | length == 0 %}\n(none)\n{% else %}\n{% for o in helper_options %}\n- {{
        o }}\n{% endfor %}\n{% endif %}\n\n{% if schedules | length == 0 %}\nNo climate.climate_scheduler_climate_schedule_*
        entities found.\n{% else %}\n\n{# Build union/intersection RAW #}\n{% set
        union = namespace(items=[]) %}\n{% set inter = namespace(items=[]) %}\n{%
        set first = true %}\n\n{# Collect all raw strings + their normalized keys
        to detect whitespace-only mismatches #}\n{% set norm_map = namespace(keys=[],
        variants_raw=[], sources=[]) %}\n\n{# helper into norm_map #}\n{% for raw
        in helper_options %}\n  {% set norm = raw | regex_replace('\\s+',' ') | trim
        %}\n  {% set idx = norm_map.keys.index(norm) if norm in norm_map.keys else
        -1 %}\n  {% if idx == -1 %}\n    {% set norm_map.keys = norm_map.keys + [norm]
        %}\n    {% set norm_map.variants_raw = norm_map.variants_raw + [[raw]] %}\n
        \   {% set norm_map.sources = norm_map.sources + [['helper']] %}\n  {% else
        %}\n    {% if raw not in norm_map.variants_raw[idx] %}\n      {% set cur =
        norm_map.variants_raw[idx] + [raw] %}\n      {% set norm_map.variants_raw
        = norm_map.variants_raw[:idx] + [cur] + norm_map.variants_raw[idx+1:] %}\n
        \   {% endif %}\n    {% if 'helper' not in norm_map.sources[idx] %}\n      {%
        set cur2 = norm_map.sources[idx] + ['helper'] %}\n      {% set norm_map.sources
        = norm_map.sources[:idx] + [cur2] + norm_map.sources[idx+1:] %}\n    {% endif
        %}\n  {% endif %}\n{% endfor %}\n\n=== Per-schedule checks (raw, exact) ===\n{%
        for e in schedules %}\n  {% set group = state_attr(e,'group_name') or e %}\n
        \ {% set modes = state_attr(e,'preset_modes') or [] %}\n\n- {{ group }} ({{
        e }}) profiles: {{ modes | length }}\n\n  {# RAW missing helper options in
        this schedule #}\n  {% set missing = namespace(items=[]) %}\n  {% for ho in
        helper_options %}\n    {% if ho not in modes %}\n      {% set missing.items
        = missing.items + [ho] %}\n    {% endif %}\n  {% endfor %}\n  {% if missing.items
        | length > 0 %}\n  MISSING (from schedule): {{ missing.items | join(' | ')
        }}\n  {% endif %}\n\n  {# RAW schedule profiles not present in helper #}\n
        \ {% set extra = namespace(items=[]) %}\n  {% for m in modes %}\n    {% if
        m not in helper_options %}\n      {% set extra.items = extra.items + [m] %}\n
        \   {% endif %}\n  {% endfor %}\n  {% if extra.items | length > 0 %}\n  EXTRA
        (not in helper): {{ extra.items | join(' | ') }}\n  {% endif %}\n\n  {# Build
        RAW union #}\n  {% for m in modes %}\n    {% if m not in union.items %}\n
        \     {% set union.items = union.items + [m] %}\n    {% endif %}\n  {% endfor
        %}\n\n  {# Build RAW intersection #}\n  {% if first %}\n    {% set inter.items
        = modes %}\n    {% set first = false %}\n  {% else %}\n    {% set new_inter
        = namespace(items=[]) %}\n    {% for x in inter.items %}\n      {% if x in
        modes %}\n        {% set new_inter.items = new_inter.items + [x] %}\n      {%
        endif %}\n    {% endfor %}\n    {% set inter.items = new_inter.items %}\n
        \ {% endif %}\n\n  {# Add schedule modes into norm_map #}\n  {% for raw in
        modes %}\n    {% set norm = raw | regex_replace('\\s+',' ') | trim %}\n    {%
        set idx = norm_map.keys.index(norm) if norm in norm_map.keys else -1 %}\n
        \   {% if idx == -1 %}\n      {% set norm_map.keys = norm_map.keys + [norm]
        %}\n      {% set norm_map.variants_raw = norm_map.variants_raw + [[raw]] %}\n
        \     {% set norm_map.sources = norm_map.sources + [[group]] %}\n    {% else
        %}\n      {% if raw not in norm_map.variants_raw[idx] %}\n        {% set cur
        = norm_map.variants_raw[idx] + [raw] %}\n        {% set norm_map.variants_raw
        = norm_map.variants_raw[:idx] + [cur] + norm_map.variants_raw[idx+1:] %}\n
        \     {% endif %}\n      {% if group not in norm_map.sources[idx] %}\n        {%
        set cur2 = norm_map.sources[idx] + [group] %}\n        {% set norm_map.sources
        = norm_map.sources[:idx] + [cur2] + norm_map.sources[idx+1:] %}\n      {%
        endif %}\n    {% endif %}\n  {% endfor %}\n\n{% endfor %}\n\n=== Intersection
        (common to ALL schedules, raw/exact) ===\n{% if inter.items | length == 0
        %}\n(none)\n{% else %}\n{% for x in inter.items | sort %}\n- {{ x }}\n{% endfor
        %}\n{% endif %}\n\n=== Union (all schedule profiles, raw/exact) ===\n{% if
        union.items | length == 0 %}\n(none)\n{% else %}\n{% for x in union.items
        | sort %}\n- {{ x }}\n{% endfor %}\n{% endif %}\n\n=== Whitespace/spelling
        variants (same normalized text, different raw strings) ===\n{% set any = false
        %}\n{% for i in range(0, norm_map.keys | length) %}\n  {% set variants = norm_map.variants_raw[i]
        %}\n  {% if variants | length > 1 %}\n    {% set any = true %}\n- Normalized:
        {{ norm_map.keys[i] }}\n  Variants: {{ variants | join(' | ') }}\n  Seen in:
        {{ norm_map.sources[i] | join(', ') }}\n  {% endif %}\n{% endfor %}\n{% if
        not any %}\n(none)\n{% endif %}\n\n{% endif %}"
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ issues_found or verbose_mode }}'
      sequence:
      - action: persistent_notification.create
        data:
          title: '{{ notif_title }}'
          message: '{{ report }}'
    default: []
  description: ''
home_mode_sync_single_source_of_truth:
  alias: Home Mode - Sync (single source of truth)
  mode: queued
  max: 5
  fields:
    home_mode:
      description: If provided, apply this Home Mode to lighting+climate. If omitted,
        derive Home Mode from lighting+climate.
      example: People home
    audit:
      description: If true, validate mapping vs input_select options and report; do
        not change anything.
      example: true
    verbose:
      description: Only relevant in audit mode. If true, report even when no problems
        are found.
      example: true
  sequence:
  - variables:
      home: input_select.home_mode
      light: input_select.lighting_mode
      climate: input_select.climate_active_profile
      lock: input_boolean.home_mode_sync
      mapping:
        People home:
          lighting: 'Humans at Home: no simulation'
          climate: 'Default: School Day / Home Office / Weekend'
        School break:
          lighting: 'Humans at Home: no simulation'
          climate: 'School Break: Everyone Mostly at Home'
        Nobody home:
          lighting: 'Nobody Home: simulated occupancy'
          climate: 'Day Absence: School Day / Office / Day Trip'
        Lulu home alone:
          lighting: 'Lulu Home Alone: simulated occupancy + corridor lights'
          climate: 'Day Absence: School Day / Office / Day Trip'
        Vacation:
          lighting: 'Nobody Home: simulated occupancy'
          climate: 'Vacation: Multiple-Day Absence'
      requested_home_mode: '{{ home_mode | default('''', true) }}'
      cur_light: '{{ states(light) }}'
      cur_climate: '{{ states(climate) }}'
      audit_mode: '{{ audit | default(false) }}'
      verbose_mode: '{{ verbose | default(false) }}'
  - variables:
      home_options: '{{ state_attr(home, ''options'') | default([], true) }}'
      light_options: '{{ state_attr(light, ''options'') | default([], true) }}'
      climate_options: '{{ state_attr(climate, ''options'') | default([], true) }}'
      unmapped_home_modes: "{% set ns = namespace(items=[]) %} {% for hm in home_options
        %}\n  {% if hm not in ['Manual Override'] and hm not in mapping.keys() %}\n
        \   {% set ns.items = ns.items + [hm] %}\n  {% endif %}\n{% endfor %} {{ ns.items
        }}"
      invalid_home_mode_keys: "{% set ns = namespace(items=[]) %} {% for k in mapping.keys()
        %}\n  {% if k not in home_options %}\n    {% set ns.items = ns.items + [k]
        %}\n  {% endif %}\n{% endfor %} {{ ns.items }}"
      invalid_lighting_values: "{% set ns = namespace(items=[]) %} {% for k, v in
        mapping.items() %}\n  {% if v.lighting not in light_options %}\n    {% set
        ns.items = ns.items + [k ~ ' -> ' ~ v.lighting] %}\n  {% endif %}\n{% endfor
        %} {{ ns.items }}"
      invalid_climate_values: "{% set ns = namespace(items=[]) %} {% for k, v in mapping.items()
        %}\n  {% if v.climate not in climate_options %}\n    {% set ns.items = ns.items
        + [k ~ ' -> ' ~ v.climate] %}\n  {% endif %}\n{% endfor %} {{ ns.items }}"
      duplicate_pairs: "{% set seen = namespace(pairs={}) %} {% for k, v in mapping.items()
        %}\n  {% set key = v.lighting ~ ' || ' ~ v.climate %}\n  {% if key in seen.pairs
        %}\n    {% set seen.pairs = dict(seen.pairs, **{ key: seen.pairs[key] + [k]
        }) %}\n  {% else %}\n    {% set seen.pairs = dict(seen.pairs, **{ key: [k]
        }) %}\n  {% endif %}\n{% endfor %} {% set ns = namespace(items=[]) %} {% for
        p, modes in seen.pairs.items() %}\n  {% if modes | length > 1 %}\n    {% set
        ns.items = ns.items + [p ~ ' => ' ~ (modes | join(', '))] %}\n  {% endif %}\n{%
        endfor %} {{ ns.items }}"
      audit_ok: "{{\n  (unmapped_home_modes | length == 0)\n  and (invalid_home_mode_keys
        | length == 0)\n  and (invalid_lighting_values | length == 0)\n  and (invalid_climate_values
        | length == 0)\n  and (duplicate_pairs | length == 0)\n}}"
      mapped_home_modes: '{{ mapping.keys() | list | sort }}'
      mapped_lighting_options: "{% set ns = namespace(items=[]) %} {% for k, v in
        mapping.items() %}\n  {% if v.lighting not in ns.items %}\n    {% set ns.items
        = ns.items + [v.lighting] %}\n  {% endif %}\n{% endfor %} {{ ns.items | sort
        }}"
      mapped_climate_options: "{% set ns = namespace(items=[]) %} {% for k, v in mapping.items()
        %}\n  {% if v.climate not in ns.items %}\n    {% set ns.items = ns.items +
        [v.climate] %}\n  {% endif %}\n{% endfor %} {{ ns.items | sort }}"
      home_options_missing_in_mapping: "{% set ns = namespace(items=[]) %} {% for
        o in home_options %}\n  {% if o not in mapped_home_modes %}\n    {% set ns.items
        = ns.items + [o] %}\n  {% endif %}\n{% endfor %} {{ ns.items | sort }}"
      lighting_options_missing_in_mapping: "{% set ns = namespace(items=[]) %} {%
        for o in light_options %}\n  {% if o not in mapped_lighting_options %}\n    {%
        set ns.items = ns.items + [o] %}\n  {% endif %}\n{% endfor %} {{ ns.items
        | sort }}"
      climate_options_missing_in_mapping: "{% set ns = namespace(items=[]) %} {% for
        o in climate_options %}\n  {% if o not in mapped_climate_options %}\n    {%
        set ns.items = ns.items + [o] %}\n  {% endif %}\n{% endfor %} {{ ns.items
        | sort }}"
      audit_message: "{% set lines = [] %}\n{% if unmapped_home_modes|length > 0 %}\n
        \ {% set lines = lines + ['home_mode options missing mapping: ' ~ (unmapped_home_modes|join(',
        '))] %}\n{% endif %}\n{% if invalid_home_mode_keys|length > 0 %}\n  {% set
        lines = lines + ['mapping keys not in home_mode options: ' ~ (invalid_home_mode_keys|join(',
        '))] %}\n{% endif %}\n{% if invalid_lighting_values|length > 0 %}\n  {% set
        lines = lines + ['invalid lighting options referenced: ' ~ (invalid_lighting_values|join(';
        '))] %}\n{% endif %}\n{% if invalid_climate_values|length > 0 %}\n  {% set
        lines = lines + ['invalid climate options referenced: ' ~ (invalid_climate_values|join(';
        '))] %}\n{% endif %}\n{% if duplicate_pairs|length > 0 %}\n  {% set lines
        = lines + ['duplicate lighting+climate pairs: ' ~ (duplicate_pairs|join('
        | '))] %}\n{% endif %}\n{{ lines | join('\\n') }}"
      audit_ok_message: "✅ Mapping audit passed.\n\nHome Mode coverage\n- home_mode
        options: {{ home_options | length }}\n- mapping keys: {{ mapped_home_modes
        | length }}\n- options missing in mapping:\n{% if home_options_missing_in_mapping
        | length > 0 %}\n{% for o in home_options_missing_in_mapping %}\n  * {{ o
        }}\n{% endfor %}\n{% else %}\n  * (none)\n{% endif %}\n\nLighting coverage\n-
        lighting_mode options: {{ light_options | length }}\n- options referenced
        by mapping: {{ mapped_lighting_options | length }}\n- lighting options NOT
        referenced by mapping:\n{% if lighting_options_missing_in_mapping | length
        > 0 %}\n{% for o in lighting_options_missing_in_mapping %}\n  * {{ o }}\n{%
        endfor %}\n{% else %}\n  * (none)\n{% endif %}\n\nClimate coverage\n- climate
        profile options: {{ climate_options | length }}\n- options referenced by mapping:
        {{ mapped_climate_options | length }}\n- climate options NOT referenced by
        mapping:\n{% if climate_options_missing_in_mapping | length > 0 %}\n{% for
        o in climate_options_missing_in_mapping %}\n  * {{ o }}\n{% endfor %}\n{%
        else %}\n  * (none)\n{% endif %}\n\nConsistency checks\n- unknown home_mode
        mapping keys: {{ invalid_home_mode_keys | length }}\n- invalid lighting references:
        {{ invalid_lighting_values | length }}\n- invalid climate references: {{ invalid_climate_values
        | length }}\n- ambiguous derive (duplicate lighting+climate pairs): {{ duplicate_pairs
        | length }}"
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ audit_mode and (not audit_ok or verbose_mode) }}'
      sequence:
      - action: persistent_notification.create
        data:
          title: Home Mode Mapping Audit {{ '✅' if audit_ok else '❌' }}
          message: '{{ audit_ok_message if audit_ok else audit_message }}'
      - stop: Audit mode
    - conditions:
      - condition: template
        value_template: '{{ audit_mode }}'
      sequence:
      - stop: Audit mode silent
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ requested_home_mode | trim != '''' }}'
      sequence:
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ requested_home_mode == ''Manual Override'' }}'
          sequence: []
        default:
        - action: input_boolean.turn_on
          target:
            entity_id: '{{ lock }}'
        - delay: 00:00:01
        - variables:
            entry: '{{ mapping.get(requested_home_mode) }}'
        - choose:
          - conditions:
            - condition: template
              value_template: '{{ entry is not none }}'
            sequence:
            - action: input_select.select_option
              target:
                entity_id: '{{ light }}'
              data:
                option: '{{ entry.lighting }}'
            - action: input_select.select_option
              target:
                entity_id: '{{ climate }}'
              data:
                option: '{{ entry.climate }}'
          - conditions: []
            sequence:
            - action: input_select.select_option
              target:
                entity_id: '{{ home }}'
              data:
                option: Manual Override
        - delay: 00:00:01
        - action: input_boolean.turn_off
          target:
            entity_id: '{{ lock }}'
    - conditions: []
      sequence:
      - variables:
          matches: "{% set ns = namespace(items=[]) %} {% for k, v in mapping.items()
            %}\n  {% if v.lighting == cur_light and v.climate == cur_climate %}\n
            \   {% set ns.items = ns.items + [k] %}\n  {% endif %}\n{% endfor %} {{
            ns.items }}"
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ matches | length == 1 }}'
          sequence:
          - action: input_select.select_option
            target:
              entity_id: '{{ home }}'
            data:
              option: '{{ matches[0] }}'
        default:
        - action: input_select.select_option
          target:
            entity_id: '{{ home }}'
          data:
            option: Manual Override
  description: ''
toggle_all_light_switches:
  alias: Toggle all light switches
  mode: single
  icon: mdi:lightbulb-group
  sequence:
  - target:
      entity_id: "{{ state_attr('sensor.light_switch_entity_list', 'entities')\n   |
        default([], true) }}\n"
    action: homeassistant.toggle
  description: ''
all_light_switches_on:
  alias: All light switches on
  mode: single
  icon: mdi:lightbulb-group
  sequence:
  - target:
      entity_id: "{{ state_attr('sensor.light_switch_entity_list', 'entities')\n   |
        default([], true) }}\n"
    action: homeassistant.turn_on
  description: ''
all_light_switches_off:
  alias: All light switches off
  mode: single
  icon: mdi:lightbulb-group-off
  sequence:
  - target:
      entity_id: "{{ state_attr('sensor.light_switch_entity_list', 'entities')\n   |
        default([], true) }}\n"
    action: homeassistant.turn_off
  description: ''
