- id: '1765067175127'
  alias: Shutters - Open Sunrise / Close Sunset
  description: ''
  triggers:
  - trigger: sun
    event: sunrise
    offset: -00:10:00
    id: sunrise_offset
  - trigger: sun
    event: sunset
    offset: 00:10:00
    id: sunset_offset
  - trigger: homeassistant
    event: start
    id: ha_start
  - trigger: time_pattern
    minutes: /15
    id: periodic
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id: ha_start
      sequence:
      - delay: 00:00:05
  - choose:
    - conditions:
      - condition: trigger
        id: sunrise_offset
      sequence:
      - action: cover.set_cover_position
        target:
          entity_id: '{{ members }}'
        data:
          position: 100
    - conditions:
      - condition: trigger
        id: sunset_offset
      sequence:
      - action: cover.set_cover_position
        target:
          entity_id: '{{ members }}'
        data:
          position: 0
    - conditions:
      - condition: template
        value_template: '{{ should_be_open }}'
      sequence:
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ eligible_members | length > 0 }}'
          sequence:
          - action: cover.set_cover_position
            target:
              entity_id: '{{ eligible_members }}'
            data:
              position: 100
    default:
    - choose:
      - conditions:
        - condition: template
          value_template: '{{ eligible_members | length > 0 }}'
        sequence:
        - action: cover.set_cover_position
          target:
            entity_id: '{{ eligible_members }}'
          data:
            position: 0
  variables:
    open_offset_s: -600
    close_offset_s: 600
    now_ts: '{{ as_timestamp(utcnow()) | float }}'
    next_rising_ts: '{{ as_timestamp(state_attr(''sun.sun'',''next_rising'')) | float
      }}'
    next_setting_ts: '{{ as_timestamp(state_attr(''sun.sun'',''next_setting'')) |
      float }}'
    sunrise_day_ts: "{% if is_state('sun.sun','above_horizon') %}\n  {{ next_rising_ts
      - 86400 }}\n{% else %}\n  {{ next_rising_ts }}\n{% endif %}"
    sunset_day_ts: "{% if now_ts < next_setting_ts %}\n  {{ next_setting_ts }}\n{%
      else %}\n  {{ next_setting_ts - 86400 }}\n{% endif %}"
    open_ts: '{{ sunrise_day_ts + open_offset_s }}'
    close_ts: '{{ sunset_day_ts + close_offset_s }}'
    should_be_open: '{{ open_ts <= now_ts < close_ts }}'
    members: '{{ expand(''cover.shutters'') | map(attribute=''entity_id'') | list
      }}'
    boundary_ts: "{% if should_be_open %}\n  {{ open_ts }}\n{% else %}\n  {{ close_ts
      }}\n{% endif %}"
    eligible_members: "{% set ns = namespace(out=[]) %} {% for s in expand('cover.shutters')
      %}\n  {% set was_manual = (s.context.user_id is not none) %}\n  {% set changed_ts
      = as_timestamp(s.last_changed) | float %}\n  {% if not (was_manual and changed_ts
      > boundary_ts) %}\n    {% set ns.out = ns.out + [s.entity_id] %}\n  {% endif
      %}\n{% endfor %} {{ ns.out }}"
  mode: single
- id: '1765675206636'
  alias: Desk button Tom's office
  description: ''
  triggers:
  - domain: mqtt
    device_id: 47273dc032abf74c01d5c349e2fd2559
    type: action
    subtype: single
    trigger: device
  - trigger: state
    entity_id:
    - update.tom_s_office_button_near_window
  conditions: []
  actions:
  - type: toggle
    device_id: c163cb454b5f1a3823390e4df3a72908
    entity_id: 34cff283dd99109d4026545fb55827b4
    domain: switch
  mode: single
- id: '1766288749763'
  alias: Turn off all lights at 3am
  description: ''
  triggers:
  - at: 03:00:00
    trigger: time
  actions:
  - target:
      entity_id: '{{ state_attr(''sensor.light_switch_entity_list'', ''entities'')
        }}

        '
    action: switch.turn_off
    data: {}
  mode: single
- id: '1767731169677'
  alias: Climate Scheduler - Apply dropdown profile to all groups
  triggers:
  - entity_id: input_select.climate_active_profile
    trigger: state
  actions:
  - data:
      profile_name: '{{ trigger.to_state.state }}'
    action: script.climate_scheduler_set_all_groups_profile
  mode: single
- id: '1768167124821'
  alias: Lighting Mode â†’ Presence Simulation
  triggers:
  - entity_id: input_select.lighting_mode
    trigger: state
  actions:
  - choose:
    - conditions:
      - condition: state
        entity_id: input_select.lighting_mode
        state:
        - 'Humans at Home: no simulation'
      sequence:
      - target:
          entity_id:
          - switch.presence_simulation_lights
          - group.simulated_occupancy_lights
          - switch.ground_floor_corridor_light
          - switch.first_floor_corridor_light
        action: switch.turn_off
    - conditions:
      - condition: state
        entity_id: input_select.lighting_mode
        state:
        - 'Nobody Home: simulated occupancy'
      sequence:
      - target:
          entity_id: '{{ state_attr(''sensor.light_switch_entity_list'', ''entities'')
            }}

            '
        action: switch.turn_off
      - target:
          entity_id: switch.presence_simulation_lights
        action: switch.turn_on
    - conditions:
      - condition: state
        entity_id: input_select.lighting_mode
        state:
        - 'Lulu Home Alone: simulated occupancy + corridor lights'
      sequence:
      - target:
          entity_id: '{{ state_attr(''sensor.light_switch_entity_list'', ''entities'')
            }}

            '
        action: switch.turn_off
      - target:
          entity_id:
          - switch.presence_simulation_lights
          - switch.ground_floor_corridor_light
          - switch.first_floor_corridor_light
        action: switch.turn_on
  mode: restart
- id: '1768355905993'
  alias: Home Mode -> Lighting Mode + Heating Profile
  triggers:
  - trigger: state
    entity_id: input_select.home_mode
  conditions:
  - condition: template
    value_template: '{{ trigger.to_state.state != ''Manual Override'' }}'
  actions:
  - action: script.home_mode_sync_single_source_of_truth
    data:
      home_mode: '{{ trigger.to_state.state }}'
  mode: restart
- id: '1768355952422'
  alias: Lighting/Heating change -> set Home Mode (auto-exit override)
  triggers:
  - trigger: state
    entity_id:
    - input_select.lighting_mode
    - input_select.climate_active_profile
  conditions:
  - condition: state
    entity_id: input_boolean.home_mode_sync
    state: 'off'
  actions:
  - delay: 00:00:01
  - action: script.home_mode_sync_single_source_of_truth
  mode: restart
- id: '1768679660123'
  alias: Audits - Nightly (Home Mode + Climate Scheduler)
  description: ''
  triggers:
  - at: 03:15:00
    trigger: time
  actions:
  - data:
      audit: true
      verbose: false
    action: script.home_mode_sync_single_source_of_truth
  - action: script.climate_scheduler_audit_profiles_consistency
    data: {}
  mode: single
- id: '1769327688422'
  alias: 'Kitchen Heating: external room temperature'
  description: ''
  triggers:
  - entity_id: sensor.kitchen_thermometer_temperature
    trigger: state
  - minutes: /1
    trigger: time_pattern
  conditions:
  - condition: template
    value_template: '{{ states(''sensor.kitchen_thermometer_temperature'') | is_number
      }}

      '
  actions:
  - target:
      entity_id: select.kitchen_heating_temperature_sensor_select
    data:
      option: external
    action: select.select_option
  - variables:
      t_room: '{{ (states(''sensor.kitchen_thermometer_temperature'') | float) | round(1)
        }}

        '
      t_last: '{{ states(''number.kitchen_heating_external_temperature_input'') }}

        '
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ not (t_last | is_number) or (t_last | float) != (t_room
          | float) }}

          '
      sequence:
      - target:
          entity_id: number.kitchen_heating_external_temperature_input
        data:
          value: '{{ t_room }}'
        action: number.set_value
  mode: single
